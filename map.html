<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è»Šç¨‹ç™¼èµ·è¡¨å–®</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #form-container { padding: 16px; background: #f9f9f9; }
    label { display: block; margin: 8px 0 4px; }
    input, select { width: 100%; padding: 8px; margin-bottom: 12px; }
    .map-section { position: relative; margin: 12px 0; }
    .map { width: 100%; height: 300px; }
    .pin {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -100%);
      z-index: 10;
      pointer-events: none;
    }
    button { padding: 10px; width: 100%; background: #28a745; color: white; border: none; border-radius: 4px; }
    .autocomplete-suggestions {
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: white;
      z-index: 99;
    }
    .autocomplete-suggestion {
      padding: 8px;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background-color: #f0f0f0;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #confirmationBox {
      background: #fff;
      border: 1px solid #ccc;
      padding: 16px;
      margin: 16px;
      border-radius: 8px;
      display: none;
    }
    #confirmationBox img {
      width: 100%; margin-top: 12px;
    }
  </style>
</head>
<body>
  <div id="form-container">
    <label id="timeLabel">é è¨ˆå‡ºç™¼æ™‚é–“</label>
    <input type="datetime-local" id="startTime">

    <label id="passengerLabel">é è¨ˆä¹˜å®¢æ•¸</label>
    <select id="passengerCount">
      <option value="">è«‹é¸æ“‡</option>
      <option value="1">1äºº</option>
      <option value="2">2äºº</option>
      <option value="3">3äºº</option>
    </select>

    <label>èµ·é»</label>
    <input id="originInput" placeholder="è¼¸å…¥èµ·é»åœ°å€" onfocus="activeField='origin'">
    <div id="originSuggestions" class="autocomplete-suggestions"></div>

    <label>çµ‚é»</label>
    <input id="destinationInput" placeholder="è¼¸å…¥çµ‚é»åœ°å€" onfocus="activeField='destination'">
    <div id="destinationSuggestions" class="autocomplete-suggestions"></div>
  </div>

  <div class="map-section" id="mapContainer">
    <div id="map" class="map"></div>
    <img src="https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2.png" class="pin">
  </div>

  <div style="padding: 16px;">
    <button id="submitBtn" onclick="submitForm()" disabled>é€å‡º</button>
  </div>

  <div id="confirmationBox"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHz0Ik6s9mObEHKLJYQ4WnoWka4OxGczY&libraries=places"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const liffId = "2007468622-N97n1j1Y";
    let map, geocoder, activeField, autocompleteService;

    async function initApp() {
      await liff.init({ liffId });
      geocoder = new google.maps.Geocoder();
      autocompleteService = new google.maps.places.AutocompleteService();

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 25.0330, lng: 121.5654 },
        zoom: 15,
      });

      map.addListener('dragend', () => {
  const center = map.getCenter();
  geocoder.geocode({ location: center }, (results, status) => {
    if (status === 'OK' && results[0]) {
      const components = results[0].address_components;
      const city = components.find(c => c.types.includes('administrative_area_level_1'))?.long_name || '';
      const district = components.find(c => c.types.includes('administrative_area_level_2'))?.long_name || '';
      const route = components.find(c => c.types.includes('route'))?.long_name || '';
      let number = components.find(c => c.types.includes('street_number'))?.long_name || '';
      if (number && !number.endsWith('è™Ÿ')) number += 'è™Ÿ';
      const formatted = `${city}${district}${route}${number}`;
      document.getElementById(activeField + 'Input').value = formatted;
      window[activeField + 'Info'] = { city, district, route, number };
      validateForm(); // âœ… åŠ å…¥æ‹–å‹•åœ°åœ–å¾Œè§¸ç™¼æª¢æŸ¥
    }
  });
});

      setupAutocomplete('origin');
      setupAutocomplete('destination');
    }

    function setupAutocomplete(field) {
      const input = document.getElementById(field + 'Input');
      const suggestionBox = document.getElementById(field + 'Suggestions');

      input.addEventListener('input', () => {
        const query = input.value;
        if (!query) {
          suggestionBox.innerHTML = '';
          return;
        }
        autocompleteService.getPlacePredictions({ input: query }, (predictions, status) => {
          if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) return;
          suggestionBox.innerHTML = '';
          predictions.forEach(prediction => {
            const div = document.createElement('div');
            div.className = 'autocomplete-suggestion';
            div.textContent = prediction.description;
            div.onclick = () => {
              input.value = prediction.description;
              suggestionBox.innerHTML = '';
              geocoder.geocode({ address: prediction.description }, (results, status) => {
                if (status === 'OK') {
                  map.setCenter(results[0].geometry.location);
                }
              });
            };
            suggestionBox.appendChild(div);
          });
        });
      });
    }

    async function submitForm() {
  const startTime = document.getElementById("startTime").value;
  const passengerCount = document.getElementById("passengerCount").value;
  const origin = document.getElementById("originInput").value;
  const destination = document.getElementById("destinationInput").value;
  const confirmationBox = document.getElementById("confirmationBox");

  document.getElementById("startTime").disabled = true;
  document.getElementById("passengerCount").disabled = true;
  document.getElementById("originInput").disabled = true;
  document.getElementById("destinationInput").disabled = true;

  // âœ… æ”¹æˆ await ç­‰å¾… directions result
  const service = new google.maps.DirectionsService();
  const result = await new Promise((resolve, reject) => {
    service.route({ origin, destination, travelMode: 'DRIVING' }, (res, status) => {
      if (status === 'OK') resolve(res);
      else reject(new Error("ç„¡æ³•å–å¾—è·¯ç·š"));
    });
  });

  const duration = result.routes[0].legs[0].duration.text;
  const polyline = result.routes[0].overview_polyline.points;
  const rawMapUrl = `https://maps.googleapis.com/maps/api/staticmap?size=400x200&path=enc:${polyline}&markers=color:green|label:S|${origin}&markers=color:red|label:E|${destination}&key=AIzaSyBHz0Ik6s9mObEHKLJYQ4WnoWka4OxGczY`;

  try {
    const resp = await fetch(`https://liff-map-api.vercel.app/api/staticmap?snapshotUrl=${encodeURIComponent(rawMapUrl)}`);
    const data = await resp.json();
    const snapshotBase64 = data.base64;

    window._submitData = {
      startTime, passengerCount, origin, destination, snapshot: snapshotBase64,
      originCity: window.originInfo?.city || '',
      destinationCity: window.destinationInfo?.city || '',
      duration
    };

    confirmationBox.innerHTML = `
      <strong>è«‹ç¢ºèªä»¥ä¸‹è³‡è¨Šï¼š</strong><br>
      å‡ºç™¼æ™‚é–“ï¼š${startTime}<br>
      ä¹˜å®¢æ•¸ï¼š${passengerCount}<br>
      èµ·é»ï¼š${origin}<br>
      çµ‚é»ï¼š${destination}<br>
      é è¨ˆè»Šç¨‹æ™‚é–“ï¼š${duration}<br>
      <img src="${snapshotBase64}" alt="è·¯ç·šåœ–"><br><br>
      <button onclick="goBack()">å›ä¸Šä¸€é </button><br><br>
      <button onclick="confirmSend()">ç¢ºèªé€å‡º</button>
    `;
    confirmationBox.style.display = 'block';
  } catch (err) {
    confirmationBox.innerHTML = `<div style='color:red;'>ç„¡æ³•å–å¾—è·¯ç·šåœ–ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
    confirmationBox.style.display = 'block';
    console.error("å–å¾—ç¸®åœ–å¤±æ•—", err);
  }
}


    function confirmSend() {
  const data = window._submitData;
  const msg = `ğŸš— è»Šç¨‹ç™¼èµ·è³‡è¨Šï¼š
å‡ºç™¼æ™‚é–“ï¼š${data.startTime}
ä¹˜å®¢æ•¸ï¼š${data.passengerCount}
èµ·é»ï¼š${data.origin}
çµ‚é»ï¼š${data.destination}`;

  const payload = {
    èµ·å§‹ç¸£å¸‚: data.originCity,
    çµ‚é»ç¸£å¸‚: data.destinationCity,
    èµ·é»: data.origin,
    çµ‚é»: data.destination,
    å‡ºç™¼æ™‚é–“: data.startTime,
    å‰©é¤˜ä¹˜å®¢æ•¸: data.passengerCount
  };

  fetch("https://liff-map-api.vercel.app/api/summit", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-vercel-key": "FanFanIsFlyingInTheSky"
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(txt => console.log("å„²å­˜æˆåŠŸï¼š", txt))
  .catch(err => console.error("å„²å­˜éŒ¯èª¤ï¼š", err));

  if (liff.isInClient()) {
    liff.sendMessages([
      { type: 'text', text: msg },
      { type: 'image', originalContentUrl: data.snapshot, previewImageUrl: data.snapshot }
    ])
    .then(() => liff.closeWindow())
    .catch(err => alert("è¨Šæ¯å‚³é€å¤±æ•—ï¼š" + err));
  } else {
    alert("éåœ¨ LINE App ä¸­ï¼Œç„¡æ³•å‚³é€è¨Šæ¯" + msg);
  }
}

    function goBack() {
  document.getElementById("startTime").disabled = false;
  document.getElementById("passengerCount").disabled = false;
  document.getElementById("originInput").disabled = false;
  document.getElementById("destinationInput").disabled = false;
  document.getElementById("confirmationBox").style.display = 'none';
}

window.onload = () => {
      initApp();
      const startTimeInput = document.getElementById("startTime");
      const passengerCountInput = document.getElementById("passengerCount");
      const originInput = document.getElementById("originInput");
      const destinationInput = document.getElementById("destinationInput");

      startTimeInput.addEventListener('input', validateForm);
      passengerCountInput.addEventListener('change', validateForm);
      originInput.addEventListener('input', validateForm);
      destinationInput.addEventListener('input', validateForm);
    };

    function validateForm() {
      const startTimeInput = document.getElementById("startTime");
      const passengerCountInput = document.getElementById("passengerCount");
      const originInput = document.getElementById("originInput");
      const destinationInput = document.getElementById("destinationInput");
      const submitBtn = document.getElementById("submitBtn");
      const passengerLabel = document.getElementById("passengerLabel");
      const timeLabel = document.getElementById("timeLabel");

      let isValid = true;
      passengerLabel.style.color = "black";
      passengerLabel.textContent = "é è¨ˆä¹˜å®¢æ•¸";
      timeLabel.style.color = "black";
      timeLabel.textContent = "é è¨ˆå‡ºç™¼æ™‚é–“";

      const now = new Date();
      const selectedTime = new Date(startTimeInput.value);
      if (!startTimeInput.value || isNaN(selectedTime.getTime()) || selectedTime <= now) {
        timeLabel.style.color = "red";
        timeLabel.textContent = "é è¨ˆå‡ºç™¼æ™‚é–“ï¼ˆåƒ…èƒ½é¸æ“‡æœªä¾†çš„æ™‚é–“ï¼‰";
        isValid = false;
      }

      const passengerCount = parseInt(passengerCountInput.value);
      if (isNaN(passengerCount) || passengerCount < 1 || passengerCount > 3) {
        passengerLabel.style.color = "red";
        passengerLabel.textContent = "é è¨ˆä¹˜å®¢æ•¸ï¼ˆè«‹é¸æ“‡ 1 è‡³ 3 äººï¼‰";
        isValid = false;
      }

      if (!originInput.value || !destinationInput.value) {
        isValid = false;
      }

      submitBtn.disabled = !isValid;
    }
  </script>
</body>
</html>
